<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-6K1SEDG5LZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6K1SEDG5LZ",{anonymize_ip:!1})}</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>on-call starter kit: first actions to do when there is an incident</title><meta name=robots content="noodp"><meta name=description content="being on-call requires fast response to incidents, in this article I will mention the most useful commands I use to get an intuition on the problem."><link rel=canonical href=https://ahmedakef.github.io/posts/on-call-first-actions/><meta property="og:title" content="on-call starter kit: first actions to do when there is an incident"><meta property="og:description" content="being on-call requires fast response to incidents, in this article I will mention the most useful commands I use to get an intuition on the problem."><meta property="og:type" content="article"><meta property="og:url" content="https://ahmedakef.github.io/posts/on-call-first-actions/"><meta property="og:image" content="https://ahmedakef.github.io/img/owl.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-17T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-17T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ahmedakef.github.io/img/owl.png"><meta name=twitter:title content="on-call starter kit: first actions to do when there is an incident"><meta name=twitter:description content="being on-call requires fast response to incidents, in this article I will mention the most useful commands I use to get an intuition on the problem."><meta name=twitter:site content="@ahmed_akef_"><meta itemprop=name content="on-call starter kit: first actions to do when there is an incident"><meta itemprop=description content="being on-call requires fast response to incidents, in this article I will mention the most useful commands I use to get an intuition on the problem."><meta itemprop=datePublished content="2022-12-17T00:00:00+00:00"><meta itemprop=dateModified content="2022-12-17T00:00:00+00:00"><meta itemprop=wordCount content="1015"><meta itemprop=image content="https://ahmedakef.github.io/img/owl.png"><meta itemprop=keywords content><link rel=stylesheet href=https://ahmedakef.github.io/css/sakura.css media=screen><link rel=stylesheet href=https://ahmedakef.github.io/css/sakura-vader.css media="screen and (prefers-color-scheme: dark)"><link rel=stylesheet href=https://ahmedakef.github.io/css/custom.css></head><body><header><h1>Ahmed Akef</h1><p>Software Engineer trying to be a Site Reliability Engineer :D</p><nav><ul><li><a href=/>Home</a></li><li><a href=/about/>About</a></li></ul></nav></header><main><article><h1>on-call starter kit: first actions to do when there is an incident</h1><time datetime="2022-12-17 00:00:00 +0000 UTC" itemprop=datePublished>December 17, 2022</time><p>** I will add to this article when I learn something new</p><h2 id=introduction>Introduction&nbsp;<a class=headline-hash href=#introduction>#</a></h2><p>Being on-call requires a fast response to incidents, in this article I will
mention the most useful actions and commands I use to get a quick intuition on the problem.</p><p>I have divided the problems to:</p><ol><li>Code errors.</li><li>Latency problems.</li><li>Configurations issues</li></ol><h2 id=code-errors>Code errors&nbsp;<a class=headline-hash href=#code-errors>#</a></h2><h3 id=check-your-monitoring-platform>Check your monitoring platform&nbsp;<a class=headline-hash href=#check-your-monitoring-platform>#</a></h3><p>If your system is already integrated with a monitoring platforms like NewRelic, opening this platform will give you
a quick overview of the most occurring errors and useful aggregations to help you detect the problem quickly,
know the tool your system is using and discover its details to help you in the incident time.</p><h3 id=check-the-logs>Check the logs&nbsp;<a class=headline-hash href=#check-the-logs>#</a></h3><p>If your system already has good logging, logs will usually have things to say about the current problem.
One of the things I found useful is to filter out the noisy lines like health checks and successful requests
let&rsquo;s assume you can show the logs of your server using the command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>k logs -f -l app<span style=color:#f92672>=</span>backend
</span></span></code></pre></div><p>and that noisy lines have this pattern:</p><pre tabindex=0><code>Successful request /health_check/backend, response: 200
</code></pre><p>you can filter out this using <code>grep -v</code> which is <code>-v, --invert-match select non-matching lines</code>
so the command will be:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>k logs -f -l app<span style=color:#f92672>=</span>backend | grep -v <span style=color:#e6db74>&#34;/health_check/backend, response: 200&#34;</span>
</span></span></code></pre></div><p>what if the error is <code>500 Internal Server Error</code> which may mean that there is an internal server error?
let&rsquo;s assume the logged stack trace usually contains this line <code>/var/app/</code>
you can filter on these lines using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>k logs -f app<span style=color:#f92672>=</span>backend | grep  <span style=color:#e6db74>&#34;/var/app/&#34;</span>
</span></span></code></pre></div><p>mixing them the final line will look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>k logs -f -l app<span style=color:#f92672>=</span>backend | grep -v <span style=color:#e6db74>&#34;/health_check/backend, response: 200&#34;</span> | grep  <span style=color:#e6db74>&#34;/var/app/&#34;</span>
</span></span></code></pre></div><p>for sure every system has its tools that make things easier to debug, you have to ask your teammates about them first and try to document them to help other new developers.</p><h2 id=latency-problems>Latency problems&nbsp;<a class=headline-hash href=#latency-problems>#</a></h2><p>some times there are no errors but there is latency in your endpoints or in consuming the jobs.</p><h3 id=check-mysql-slow-queries>Check MySQL slow queries&nbsp;<a class=headline-hash href=#check-mysql-slow-queries>#</a></h3><p>Check MySQL for the query that has a big execution time, usually, people use <code>show full processlist;</code>
but I have found that this query is more useful:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> INFORMATION_SCHEMA.PROCESSLIST <span style=color:#66d9ef>WHERE</span> command <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;sleep&#34;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> TIME <span style=color:#66d9ef>DESC</span> <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------+---------+--------------------+---------+---------+------+-----------+------------------------------------------------------------------------------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> ID     <span style=color:#f92672>|</span> <span style=color:#66d9ef>USER</span>    <span style=color:#f92672>|</span> <span style=color:#66d9ef>HOST</span>               <span style=color:#f92672>|</span> DB      <span style=color:#f92672>|</span> COMMAND <span style=color:#f92672>|</span> TIME <span style=color:#f92672>|</span> <span style=color:#66d9ef>STATE</span>     <span style=color:#f92672>|</span> INFO                                                                                     <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------+---------+--------------------+---------+---------+------+-----------+------------------------------------------------------------------------------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#ae81ff>2222</span>   <span style=color:#f92672>|</span> <span style=color:#66d9ef>admin</span>   <span style=color:#f92672>|</span> <span style=color:#ae81ff>197</span>.<span style=color:#ae81ff>168</span>.<span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>2222</span>   <span style=color:#f92672>|</span> db_name <span style=color:#f92672>|</span> Query   <span style=color:#f92672>|</span>    <span style=color:#ae81ff>0</span> <span style=color:#f92672>|</span> executing <span style=color:#f92672>|</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> INFORMATION_SCHEMA.PROCESSLIST <span style=color:#66d9ef>WHERE</span> command <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;sleep&#34;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> TIME <span style=color:#66d9ef>DESC</span> <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------+---------+--------------------+---------+---------+------+-----------+------------------------------------------------------------------------------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span> sec)
</span></span></code></pre></div><p>This query:</p><ul><li>Exclude the <code>sleep</code> process since it represents connections waiting for a timeout to terminate and it is usually created by the frameworks to maintain persistent connections to the database.<ul><li>If you have a problem creating new connections, this might be useful tho.</li></ul></li><li>Order the processes by their time.</li><li>Limit the results to 10.</li></ul><p>Some ideas:</p><ul><li>If the query is processing a big number of entities, try batching.</li></ul><h3 id=check-redis-slow-queries>Check REDIS slow queries&nbsp;<a class=headline-hash href=#check-redis-slow-queries>#</a></h3><p>Using this command Redis will show the most 10 slow queries:</p><pre tabindex=0><code>SLOWLOG GET 10
</code></pre><p>According to <a href=https://redis.io/commands/slowlog-get/>docs</a>:</p><blockquote><p>The Redis Slow Log is a system to log queries that exceeded a specified execution time. The execution time does not include I/O operations like talking with the client, sending the reply and so forth, but just the time needed to actually execute the command (this is the only stage of command execution where the thread is blocked and can not serve other requests in the meantime).</p></blockquote><p>The important for us is 3rd and 4th value of each entry:</p><ol start=3><li>The amount of time needed for its execution, in microseconds.</li><li>The array composing the arguments of the command.</li></ol><p>If you think that a query consuming <code>10 ms</code> is not too much, you are wrong because when you multiply this in a 100k job for example this is ~16 minutes and this is only one operation in the job.</p><p>Some ideas to make use of the results:</p><ul><li>Detect the parts of the code that needs enhancement.<ul><li>Add a limitation on some behaviours</li></ul></li><li>Develop a quick script to fix the issue without affecting the product.</li><li>Is there a customer having weird behaviour that causes his queries to have big time?</li></ul><h2 id=configurations-issues>Configurations issues&nbsp;<a class=headline-hash href=#configurations-issues>#</a></h2><p>Sometimes scaling (vertically or horizontally) isn&rsquo;t useful and even there is no latency issue, so we have to check the configurations.</p><h3 id=check-configurations>Check configurations&nbsp;<a class=headline-hash href=#check-configurations>#</a></h3><p>It may be related to missing configurations like:</p><ul><li>No worker is consuming from the queue.</li><li>Missing environment variables that control the behaviour.</li><li>Missing DB migrations.</li></ul><p>In these scenarios, I have no clear way to detect them but I play with the resources I have to answer some questions:</p><ul><li>If I overscaled a worker, will it consume the jobs faster? if not, then there is a different problem than scaling.</li><li>If I scaled down the worker to 0, will it fix the issue? if yes, the problem is with worker logic.</li><li>If I changed the image of the code, will it fix the issue? if yes, the problem is with a recent release.</li></ul><h3 id=check-server-resources-usage>Check server resources usage&nbsp;<a class=headline-hash href=#check-server-resources-usage>#</a></h3><p>Since every system has its way to check the resources, I won&rsquo;t list detailed commands but things to check:</p><ul><li>What is CPU usage percentage?</li><li>What is memory usage percentage?</li><li>What is the disk usage percentage?</li></ul><p>If you have an incident because of one of these, you have to think about how to automate being alerted on them so you can take action earlier.</p><h3 id=check-the-audit-log>Check the audit log&nbsp;<a class=headline-hash href=#check-the-audit-log>#</a></h3><p>If all the above can&rsquo;t explain the issue, you need to check the actions that were made on your servers before the problem, probably someone made a change by mistake that caused things to not work out of the blue.</p><h2 id=finally>Finally&nbsp;<a class=headline-hash href=#finally>#</a></h2><p>You will learn on-call lessons by the time with each issue you face or by watching how your team members act on the problems and by getting more knowledge and experience with your system.</p><p>Keep calm, everything is solvable In Shaa Allah.</p><p>Share with me the useful tools you use to debug on-call issues.</p><br><hr style=height:2px;border-width:0;color:gray;background-color:gray><h4>comments:</h4><script src=https://giscus.app/client.js data-repo=ahmedakef/ahmedakef.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxOTA2NDkwNzk=" data-category=Announcements data-category-id=DIC_kwDOC10S984CTH4M data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=en crossorigin=anonymous async></script></article></main><br><footer><a href=#>&uarr;Back to top</a> || <a href=https://ahmedakef.github.io/index.xml>RSS</a>
|| <a href=https://twitter.com/ahmed_akef_>Twitter</a>
|| <a href=https://github.com/ahmedakef>GitHub</a>
|| <a href=https://www.linkedin.com/in/ahmedakef4>LinkedIn</a>
|| aemed.akef.1@gmail.com</footer></body></html>